# プロジェクト進捗ログ

## これまでの進捗サマリー

-   **2025-09-01**
    -   ログアウト時に確認ダイアログを表示する機能を追加した。
    -   **自動下書き保存機能の実装:**
        -   当初、「未保存の変更がある場合にページ離脱を警告する機能」を開発していたが、Next.js App Routerのナビゲーションの仕組みとブラウザ標準のイベントとの間に解決困難な競合が発生した。
        -   そのため、より堅牢でユーザー体験も向上する「自動下書き保存」方式へ方針を転換し、最終的に実装を完了した。
        -   日記の新規作成、編集、プロフィール設定の各フォームページに本機能を実装した。
        -   フォームへの入力内容は1.5秒ごとにブラウザの`localStorage`へ自動保存されるようにした。
        -   ページ再訪問時に未保存の下書きが存在する場合、復元を促すダイアログが表示されるようにした。
        -   フォーム送信成功時や復元不要と判断された際に、下書きは自動的に削除されるようにした。
    -   **地図移動機能の実装:**
        -   日本の各都道府県の緯度・経度データに基づき、特定の県へ地図をジャンプさせる機能を追加した。
        -   フィルターサイドバーに都道府県選択用のドロップダウンメニューを実装した。
        -   選択された県へ地図がスムーズに移動（`flyTo`）するように`MapComponent`を更新した。
-   **2025-08-11**
    -   プロジェクトディレクトリ `ikimono-nikki` を作成した。
    -   Gitリポジトリを初期化し、GitHub (`git@github.com:Tsubasashioda/ikimono_nikki.git`) に接続した。
    -   基本設計書を `README.md` として作成し、最初のコミットをプッシュした。
    -   Next.jsプロジェクト（TypeScript, Tailwind CSS, ESLint）の雛形を作成した。
    -   `README.md` の内容を更新（ターゲットユーザーの絞り込みなど）した。
    -   Next.jsのプロジェクトファイルをGitHubにプッシュした。
    -   MySQLにデータベース `ikimono_nikki` を作成した。
    -   Prismaをインストールし、MySQLへの接続設定を`.env`ファイルに記述した。
    -   Prismaでデータベーススキーマを定義し、`prisma db push`でデータベースに適用した。
    -   Next.js開発サーバーを起動し、初期設定が正しく行われたことを確認した。
    -   ユーザー登録・ログインAPIの基本構造を作成し、`bcryptjs`を導入した。
    -   ユーザー登録・ログインのフロントエンドフォームを実装した。
    -   JWTベースの認証（ログインAPI修正、ログアウトAPI作成）と認証ミドルウェアによるルーティング保護を実装した。
    -   認証フォームの文字色を修正した。
    -   認証フォームの日本語化を行った。
    -   JWTライブラリを`jsonwebtoken`から`jose`に切り替え（Edge Runtime対応）た。
    -   APIエラーメッセージの日本語化を行った。
    -   認証フローの動作確認と、APIエラーメッセージの日本語化を完了した。
    -   ルートディレクトリの不要な`package.json`, `package-lock.json`, `prisma`ディレクトリを整理した。
    -   生き物日記の投稿機能（フォーム、API、データベース保存）を実装した。
    -   package.jsonを再構築し、すべての依存関係をインストールした。
    -   **Gitリポジトリをコミット`84347e2`までロールバックし、地図関連の変更をすべて取り消した。**
    -   `/api/entries`のGETハンドラーを再々追加した。
-   **2025-08-14**
    -   `next.config.ts`に`reactStrictMode: false`を追加し、`Map container is already initialized`エラーを回避した。
    -   `leaflet`と`react-leaflet`、およびそれらの型定義ファイルを再インストールした。
    -   `src/components/MapComponent.tsx`を再作成し、地図表示機能を再導入した。
    -   `src/app/page.tsx`を更新し、`MapComponent`を統合した。
    -   `src/app/entries/new/page.tsx`を更新し、地図上での座標選択と画像アップロード機能を再実装した。
    -   `public/uploads`ディレクトリを作成した。
    -   `src/app/api/entries/[id]/route.ts`に`PUT` (更新) と `DELETE` (削除) メソッドを実装した。
    -   `src/app/api/auth/me/route.ts`にログインユーザー情報を取得する`GET`メソッドを実装した。
    -   `src/app/entries/edit/[id]/page.tsx`に日記編集ページを新規作成した。
    -   `src/app/api/entries/my/route.ts`に自分の日記一覧を取得する`GET`メソッドを実装した。
    -   `src/app/entries/my/page.tsx`に自分の日記一覧表示ページを新規作成した。
    -   `src/app/page.tsx`のヘッダーに「自分の日記」へのリンクを追加した。
    -   `src/app/api/entries/[id]/route.ts`に欠落していた`GET`メソッドを追加し、日記編集ページでのデータ取得エラーを修正した。
-   **2025-08-15**
    -   地図上の日記ピンの表示について、自分の投稿と他人の投稿を色分けする機能を実装した。
    -   非公開の日記が地図上に表示されない問題についてデバッグを実施し、バックエンドAPIは正しくデータを返していることを確認した。
    -   ユーザーの要望により、日記の公開レベル（完全に非公開、限定公開、完全公開）の概念導入を検討した。
    -   デバッグログを`src/app/page.tsx`および`src/app/api/entries/route.ts`から削除した。
    -   マイページ（ユーザープロファイル）編集機能のバックエンドAPI (`src/app/api/auth/me/route.ts`の`PUT`メソッド) を実装した。
    -   マイページ（ユーザープロファイル）編集機能のフロントエンドページ (`src/app/settings/page.tsx`) を実装した。
    -   `src/app/page.tsx`にプロフィール編集ページへのリンクを追加した。
    -   メインページのヘッダーを改修し、「プロフィール編集」リンクを動的なプロフィールアイコン表示に変更し、ユーザーがアイコンを設定している場合はその画像、未設定の場合はデフォルトのアバターが表示されるようにした。
    -   日記に公開レベル（`PRIVATE`, `PUBLIC`）を設定する機能を追加した。
        -   `schema.prisma`を更新し、`isPublic`を`privacyLevel` enumに置き換え、DBに反映させた。
        -   日記の投稿APIと一覧取得APIを`privacyLevel`に対応させた。
        -   日記の投稿ページに公開レベルを選択するUIを実装した。
    -   日記の編集機能に公開レベル設定を追加した。
        -   日記の編集・取得APIを`privacyLevel`に対応させた。
        -   日記の編集ページに公開レベルを変更するUIを実装した。
    -   フレンド機能の実装を開始した。
        -   `Friendship`モデルをDBに追加した。
        -   ユーザー検索API (`/api/users/search`) を作成した。
        -   フレンド管理ページ (`/friends`) を作成し、ユーザー検索UIを実装した。
        -   ヘッダーにフレンド管理ページへのリンクを追加した。
        -   `lodash`をインストールし、ビルドエラーを修正した。
    -   フレンド申請機能を追加した。
        -   フレンド申請API (`/api/friends/requests`) を作成した。
        -   ユーザー検索APIを、既に関係のあるユーザーを除外するように改修した。
        -   フレンド管理ページで、検索結果から実際にフレンド申請を送信できるようにし、UIを更新した。
    -   フレンド申請の承認・拒否機能を追加した。
        -   受信したフレンド申請一覧を取得するAPI (`GET /api/friends/requests`) を作成した。
        -   フレンド申請に応答するAPI (`PUT /api/friends/requests/[id]`) を作成した。
        -   フレンド管理ページで、受信した申請一覧の表示と、承認・拒否操作をできるようにした。
    -   フレンド一覧表示機能を追加した。
        -   フレンド一覧を取得するAPI (`GET /api/friends`) を作成した。
        -   フレンド管理ページで、承認済みのフレンド一覧を表示するようにした。
    -   日記の公開レベルに「フレンドのみ」を追加した。
        -   日記投稿・編集ページに「フレンドのみ」の公開設定を追加した。
        -   日記一覧取得APIを修正し、`FRIENDS_ONLY`の日記をフレンドにのみ表示するロジックを追加した。
        -   特定日記取得APIを修正し、`FRIENDS_ONLY`の日記をフレンドが閲覧できるようにするロジックを追加した。
    -   フレンド解除機能を追加した。
        -   フレンド解除API (`DELETE /api/friends/[id]`) を作成した。
        -   フレンド管理ページで、フレンド解除操作をできるようにした。
    -   ユーザープロフィールモーダルを改善した。
        -   モーダルの「×」ボタンと背景クリックで閉じない問題を修正した。
        -   モーダルのタイトルが見えない問題を修正した。
        -   プロフィールモーダルに「〇〇さんの日記を見る」ボタンを追加し、そのユーザーの日記一覧ページへ遷移するようにした。
    -   特定のユーザーの日記一覧ページをリスト表示に変更した。
        -   `/entries/user/[id]/page.tsx`の表示を地図からリスト形式に変更した。
        -   日記の削除機能もリスト表示に合わせて調整した。
    -   日記にカテゴリ機能を追加した。
        -   `Category`モデルをDBに追加した。
        -   カテゴリ一覧API (`/api/categories`) を作成した。
        -   日記投稿・編集APIを`categoryId`に対応させた。
        -   日記検索APIを`categoryId`でフィルタリングできるように修正した。
        -   日記投稿・編集ページにカテゴリ選択UIを追加した。
    -   メインページにキーワード検索機能を追加した。
        -   日記のキーワード検索API (`/api/entries/search`) を作成した。
        -   メインページに検索バーを追加し、キーワード検索ができるようにした。
        -   検索中のローディング表示を改善し、画面全体が暗転しないようにした。
    -   メインページにエリア検索機能を追加した。
        -   日記検索APIを緯度・経度の範囲でフィルタリングできるように修正した。
        -   `MapComponent`に円形描画ツールを追加し、描画された範囲の座標を親コンポーネントに渡すように修正した。
        -   メインページにエリア選択をリセットするボタンを追加した。
-   **2025-08-21**
    -   日記の検索APIを改修し、発見日（期間指定）と時間帯（朝・昼・夜）での絞り込みを可能にした。
    -   APIのレスポンスに日記投稿者の情報（ID, 名前, アイコン）を含めるようにした。
    -   メインページのフィルターUI（キーワード、カテゴリ、日付、時間帯）を、スライド式のサイドバーに集約した。
    -   地図上のポップアップを改修し、投稿者のアイコンと名前（ユーザーページへのリンク付き）を表示するようにした。
    -   ゲストログイン機能を実装し、ログインしていない状態でも公開されている日記を地図上で閲覧できるようにした。
    -   未ログインユーザー向けのヘッダーUIを実装し、ログイン/新規登録への導線を提供した。
    -   デフォルトアバター画像を追加し、アイコンが設定されていない場合に表示されるようにした。
    -   ログインボタンのスタイルを改善し、視認性を向上させた。
    -   月ごとの複数選択フィルターを追加し、年をまたいで特定の月の日記を絞り込めるようにした。
-   **2025-08-28**
    -   投稿の非表示機能の実装と関連修正を行った。
    -   投稿を非表示にするAPI (`/api/hidden-entries`) を作成した。
    -   データベースに`HiddenEntry`モデル（投稿単位の非表示）と`HiddenUser`モデル（ユーザー単位の非表示）を追加した。
    -   `MapComponent.tsx`に非表示メニューのUIとロジックを追加した。
    -   Next.jsのバージョンを`14.2.25`にダウングレードした。
    -   ユーザーを非表示にするAPI (`/api/hidden-users`) を作成した。
    -   日記一覧取得API (`/api/entries/search`) を改修し、非表示設定を反映するようにした。
    -   `page.tsx`に非表示処理のコールバック関数 (`handleHideEntry`) を追加した。
    -   ReactとReact DOMのバージョンを`18.2.0`にダウングレードした。
    -   `react-leaflet`のバージョンを`4.1.0`にダウングレードした。
    -   ビルドが成功したことを確認した。
    -   `MapComponent.tsx`の`Popup`コンポーネントの`onClose`プロパティを削除し、`useRef`と`useEffect`で`remove`イベントをリッスンするように修正した。
    -   `hidden-entries`と`hidden-users`のAPIハンドラをClerkに依存しないカスタムJWT認証を使用するように修正した。
    -   フレンド管理ページから非表示ユーザーを再表示する機能を追加した。
    -   非表示時の警告文を「フレンド管理のページから非表示一覧で直せます」という内容に変更した。
    -   非表示解除API (`DELETE /api/hidden-users/[id]`) を追加した。
    -   非表示ユーザー一覧取得API (`GET /api/hidden-users`) を追加した。
    -   フレンド管理ページ (`src/app/friends/page.tsx`) に非表示ユーザー一覧表示と解除ボタンを追加した。

## 現在の状況

-   Next.jsアプリケーションの雛形を完成させ、Prisma経由でデータベースに接続できる準備を整備した。
-   データベースに`users`と`diary_entries`テーブルを作成した。
-   開発サーバーが正常に起動することを確認した。
-   ユーザー登録・ログインのバックエンドAPIを完成させた。
-   ユーザー登録・ログインのフロントエンドフォームを完成させた。
-   JWTベースの認証システムとルーティング保護を実装した。
-   認証フローが完全に機能し、エラーメッセージも日本語で正しく表示されるようにした。
-   地図表示機能を再導入し、正常に動作するようにした。
-   日記の投稿、編集、削除機能を実装した。
-   自分の日記一覧表示機能を実装した。
-   プロフィール編集機能と、ヘッダーでの動的アイコン表示を実装した。
-   日記の投稿・編集時に公開レベルを設定できるようになった。
-   フレンド機能（申請、承認・拒否、一覧表示、解除）を実装した。
-   日記の公開レベル「フレンドのみ」を実装した。
-   ユーザープロフィールモーダルを改善し、ユーザーの日記一覧へのリンクを追加した。
-   特定のユーザーの日記一覧ページをリスト表示にした。
-   日記にカテゴリ機能を追加した。
-   メインページにキーワード検索機能を追加した。
-   メインページにエリア検索機能を追加した。
-   メインページで、発見日と時間帯によるフィルター機能が利用可能になった。
-   各種フィルター機能をサイドバーに集約し、UIを改善した。
-   地図上のポップアップで、投稿者の情報が確認できるようになった。
-   ゲストログイン機能を実装し、ログインせずに地図を閲覧できるようになった。
-   未ログインユーザー向けのUIを整備した。
-   デフォルトアバター画像を追加し、アイコン表示を改善した。
-   ログインボタンのスタイルを改善した。
-   月ごとの複数選択フィルターを追加し、年をまたいで特定の月の日記を絞り込めるようにした。
-   **「いいね」機能を実装した。**
    -   **データベースに`Like`モデルを追加し、関連するスキーマを更新した。**
    -   **「いいね」の追加・解除を切り替えるトグルAPI (`/api/likes`) を実装した。**
    -   **日記検索APIを改修し、各日記の「いいね」情報（件数、自分が「いいね」したか）をレスポンスに含めるようにした。**
    -   **メインページの地図ポップアップに「いいね」ボタンと件数を表示し、クリックで楽観的更新が走るようにした。**
-   **実装中に発生した以下のバグを修正した。**
    -   **DBに`category`テーブルが存在せず、カテゴリが取得できない問題を修正した。**
    -   **新規投稿ページで地図コンポーネントがSSRされ、`window is not defined`エラーが発生する問題を修正した。**
-  ピンの色設定を追加した。
-  日記削除機能の追加とAPIルートの改善をした。
 -   **投稿の非表示機能の実装を開始した。**
    -   データベースに`HiddenEntry`モデル（投稿単位の非表示）と`HiddenUser`モデル（ユーザー単位の非表示）を追加した。
    -   投稿を非表示にするAPI (`/api/hidden-entries`) を作成した。
    -   ユーザーを非表示にするAPI (`/api/hidden-users`) を作成した。
    -   日記一覧取得API (`/api/entries/search`) を改修し、非表示設定を反映するようにした。
    -   `MapComponent.tsx`に非表示メニューのUIとロジックを追加した。
    -   `page.tsx`に非表示処理のコールバック関数 (`handleHideEntry`, `handleHideUser`) を追加し、`MapComponent`に渡すようにした。
    -   Next.jsのバージョンを`14.2.25`にダウングレードした。
    -   ReactとReact DOMのバージョンを`18.2.0`にダウングレードした。
    -   `react-leaflet`のバージョンを`4.1.0`にダウングレードした。
    -   ビルドが成功したことを確認した。
    -   フレンド管理ページから非表示ユーザーを再表示する機能を追加した。
    -   非表示ユーザー一覧取得API (GET /api/hidden-users) を追加した。
    -   非表示解除API (DELETE /api/hidden-users/[id]) を追加した。
    -   フレンド管理ページ (src/app/friends/page.tsx) に非表示ユーザー一覧表示と解除ボタンを追加した。
    -   非表示時の警告文を「フレンド管理のページから非表示一覧で直せます」という内容に変更した。

## 次のステップ

-   **今後の改善案**: 
    -　フレンド、非表示ユーザのリスト表示
    -　しおり機能　自分や他人の投稿をフォルダ分けすることができる
    -　公開範囲の再設定（フレンドには詳しく、その他には軽く表示）
    -   コメント機能
    -   通知機能
    -   レスポンシブデザインの強化
    -　ローディングのアニメーション（だいぶ余裕あったら）
    
##gemini君へ
ユーザの問いに対する自己分析を出力しつつ進めること。
機能が完成した際にユーザに確認作業を求めること
このログをgitにpushする際に更新すること
